<?xml version="1.0"?>
<robot xmlns:xacro="http://ros.org/wiki/xacro">
    <xacro:macro name="xarm6_ros2_control" params="use_gazebo:=true namespace:='xarm6' prefix:='' velocity_control:='false'
        robot_ip:='192.168.1.205' report_type:='normal' baud_checkset:='true' 
        joint1_lower_limit:=${-2.0*pi}  joint1_upper_limit:=${2.0*pi}
        joint2_lower_limit:=${-2.059}   joint2_upper_limit:=${2.0944} 
        joint3_lower_limit:=${-3.927}   joint3_upper_limit:=${0.19198}
        joint4_lower_limit:=${-2.0*pi}  joint4_upper_limit:=${2.0*pi} 
        joint5_lower_limit:=${-1.6929}  joint5_upper_limit:=${pi}
        joint6_lower_limit:=${-2.0*pi}  joint6_upper_limit:=${2.0*pi}
        ros2_control_plugin:='uf_robot_hardware/UFRobotSystemHardware'
        hard_interface='EffortJointInterface' reduction='100'">

        <!-- Build namespace prefix -->
        <xacro:property name="ns_prefix" value="${namespace}/${prefix}"/>

        <!-- Gazebo Simulated Control -->
        <xacro:if value="${use_gazebo}">
            <ros2_control name="${namespace}/gazebo_system" type="system">
                <!-- Hardware plugin simulates joint physics -->
                <hardware>
                    <plugin>gz_ros2_control/GazeboSimSystem</plugin>
                </hardware>
                <!-- Expose position + velocity commands/states for all 6 joints -->
                <joint name="${ns_prefix}joint1">
                    <command_interface name="position"/>
                    <command_interface name="velocity"/>
                    <state_interface name="position">
                        <param name="initial_value">${pi/2}</param>
                    </state_interface>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint2">
                    <command_interface name="position"/>
                    <command_interface name="velocity"/>
                    <state_interface name="position">
                        <param name="initial_value">-${pi/4}</param>
                    </state_interface>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint3">
                    <command_interface name="position"/>
                    <command_interface name="velocity"/>
                    <state_interface name="position">
                        <param name="initial_value">-${pi/4}</param>
                    </state_interface>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint4">
                    <command_interface name="position"/>
                    <command_interface name="velocity"/>
                    <state_interface name="position">
                        <param name="initial_value">0.0</param>
                    </state_interface>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint5">
                    <command_interface name="position"/>
                    <command_interface name="velocity"/>
                    <state_interface name="position">
                        <param name="initial_value">0.0</param>
                    </state_interface>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint6">
                    <command_interface name="position"/>
                    <command_interface name="velocity"/>
                    <state_interface name="position">
                        <param name="initial_value">${pi/2}</param>
                    </state_interface>
                    <state_interface name="velocity"/>
                </joint>
            </ros2_control>
        </xacro:if>

        <!-- Real hardware -->
        <xacro:unless value="${use_gazebo}">
            <ros2_control name="${ns_prefix}${ros2_control_plugin}" type="system">
                <hardware>
                    <plugin>${ros2_control_plugin}</plugin>
                    <param name="robot_ip">${robot_ip}</param>
                    <param name="report_type">${report_type}</param>
                    <param name="baud_checkset">${baud_checkset}</param>
                </hardware>
                <joint name="${ns_prefix}joint1">
                    <command_interface name="position">
                        <param name="min">${joint1_lower_limit}</param>
                        <param name="max">${joint1_upper_limit}</param>
                    </command_interface>
                    <state_interface name="position"/>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint2">
                    <command_interface name="position">
                        <param name="min">${joint2_lower_limit}</param>
                        <param name="max">${joint2_upper_limit}</param>
                    </command_interface>
                    <state_interface name="position"/>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint3">
                    <command_interface name="position">
                        <param name="min">${joint3_lower_limit}</param>
                        <param name="max">${joint3_upper_limit}</param>
                    </command_interface>
                    <state_interface name="position"/>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint4">
                    <command_interface name="position">
                        <param name="min">${joint4_lower_limit}</param>
                        <param name="max">${joint4_upper_limit}</param>
                    </command_interface>
                    <state_interface name="position"/>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint5">
                    <command_interface name="position">
                        <param name="min">${joint5_lower_limit}</param>
                        <param name="max">${joint5_upper_limit}</param>
                    </command_interface>
                    <state_interface name="position"/>
                    <state_interface name="velocity"/>
                </joint>
                <joint name="${ns_prefix}joint6">
                    <command_interface name="position">
                        <param name="min">${joint6_lower_limit}</param>
                        <param name="max">${joint6_upper_limit}</param>
                    </command_interface>
                    <state_interface name="position"/>
                    <state_interface name="velocity"/>
                </joint>
            </ros2_control>
        </xacro:unless>
        
    </xacro:macro>
</robot>